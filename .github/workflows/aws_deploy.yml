name: Deploy to Amazon ECS

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: MY_AWS_REGION                   # set this to your preferred AWS region, e.g. us-west-1
  DOCKERHUB_USERNAME: jocamposar #usuario DockerHub
  DOCKERHUB_REPO: devospclase       #repo DockerHub
  EC2_USER: ec2-user            #usuario ec2
  EC2_HOST: 3.143.5.14          #ip publicaEc2    
  IMAGE_TAG: ${{ github.sha }}  # Tag Ãºnico por commit

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: login docker github
      uses: docker/login-action@v2
      with: 
        username: ${{secrets.DOCKERHUB_USERNAME}}
        password: ${{secrets.DOCKERHUB_TOKEN}}
    
    - name: build and push
      run: | 
        docker build -t $DOCKERHUB_USERNAME/$DOCKERHUB_REPO:$IMAGE_TAG .
        docker push $DOCKERHUB_USERNAME/$DOCKERHUB_REPO:$IMAGE_TAG
      
    - name: deploy wn AWS
      run : |
        mkdir -p ~/.ssh
        echo "${{secrets.ECS_SSH_KEY}}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

        ssh $EC2_USER@EC2_HOST "\ 
          docker pull $DOCKERHUB_USERNAME/$DOCKERHUB_REPO:$IMAGE_TAG && \
          docker stop stop mi-app || true && \
          docker rm mi-app || true && \
          docker run -d --name mi-app 80:80 $DOCKERHUB_USERNAME/$DOCKERHUB_REPO:$IMAGE_TAG \
        "
    
